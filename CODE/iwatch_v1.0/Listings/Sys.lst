C51 COMPILER V9.52.0.0   SYS                                                               05/30/2021 20:33:33 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE SYS
OBJECT MODULE PLACED IN ..\Objects\Sys.obj
COMPILER INVOKED BY: E:\install_files\keil\C51\BIN\C51.EXE ..\User\System\Sys.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..
                    -\User\System;..\User\Sensor;..\User\Rtc;..\User\Radio;..\User\Oled;..\User\Bluetooth;..\User) DEBUG OBJECTEXTEND PRINT(.
                    -.\Listings\Sys.lst) TABS(2) OBJECT(..\Objects\Sys.obj)

line level    source

   1          #include "sys.h"
   2          #include "IIC.h"
   3          #include "Delay.h"
   4          #include "PowerManage.h"
   5          #include "Buzzer.h"
   6          #include "EEPROM.h"
   7          
   8          
   9          
  10            
  11          //EEPROMûݻݲĬ
  12          const struct sys_config default_config = {
  13            //Ĭʾ
  14            10,           //ԶϢʱ
  15            5,            //Զʱ
  16            50,           //Ļȣ0~255
  17            NO_INVERSED,  //ĻǷɫ
  18            NORMAL,       //Ļʾ
  19            OFF,          //رհ
  20            //ĬӲ
  21            8,              //Сʱ
  22            30,             //
  23            1,              //1
  24            1,              //һ
  25            ALARM_DISABLE,  //ӹر
  26            //Ĭ
  27            1,      //
  28            97.1,   //Ƶ
  29            //ĬУ
  30            0,      //xƫ
  31            0,      //yƫ
  32            0,      //Уϵ
  33            0,      //Уϵ
  34            0,      //Уϵ
  35            1,      //Уϵ
  36            1,      //Уϵ
  37            {{0}, {0}, {0}, {0}, {0}, {0}, {0}},  //ƲʷݣŹȥĲ
  38            0       //Ҫ޸
  39          };
  40          
  41          extern struct sys_config config;  
  42          
  43                        
  44          void Timer0Init(void)
  45          {
  46   1        TMOD |= 0x04;   //ⲿģʽ
  47   1        TL0 = 0x00;
  48   1        TH0 = 0x00;
  49   1        TR0 = 0;       //رնʱ
  50   1        ET0 = 1;       //ʹܶʱж
  51   1      }
  52          void Timer3Init(void)    //ʱ1ms   24MHZ
  53          {
C51 COMPILER V9.52.0.0   SYS                                                               05/30/2021 20:33:33 PAGE 2   

  54   1        T4T3M |= 0x02;     //T4R T4_C/T T4x12 T4CLKO ʱʱ1TģʽCPUʱӲƵfosc/1
  55   1        T3L = 0x40;        //öʱֵ
  56   1        T3H = 0xA2;        //öʱֵ
  57   1        T4T3M |= 0x08;     //ʱ3ʼʱ
  58   1        IE2 |= ET2;        //ʱ3ж
  59   1      }
  60          void InitConfig(void)
  61          {
  62   1        IT0 = 1;    //ʹINT0½жϣӦPCF8653ж
  63   1        EX0 = 1;    //ʹINT0ж
  64   1        IT1 = 1;    //ʹINT1½жϣӦLSM6DSMжINT1
  65   1        EX1 = 1;    //ʹINT1ж
  66   1        INTCLKO |= EX2; //ʹINT2ж    ӦLSM6DDSMж2
  67   1        INTCLKO |= EX3;  //ʹINT3ж    Ӧ2жϣ
  68   1        //INTCLKO |= EX4;  //ʹINT4ж 
  69   1      }
  70          
  71          //ڶúʱʹifdef else
  72          void UartInit(void)       //115200bps@24.000MHz
  73          {
  74   1        SCON = 0x50;  // SM0 SM1 SM2 REN TB RB8 TI RI 8λݣɱ䲨
  75   1        AUXR |= 0x40;  //   AUXRĴT1x12Ϊ1CPUʱӲƵΪ0Ϊ12Ƶ
  76   1        AUXR &= 0xFE;  //  bit0⣬λԭò
  77   1        TMOD &= 0x0F;  //   4λ GATE C/T M1 M0    λ㣬λֲ(T1-gate,T1Ϊʱ
             -ϵͳڲʱӽмΪ16λԶװģʽT0ֲ)
  78   1        TL1 = 0xCC;    //   0xcc  204
  79   1        TH1 = 0xFF;    //   0xff  255    ÿװǶ
  80   1        ET1 = 0;       //   ʱ/T1жλֹT1ж
  81   1        TR1 = 1;       //   򿪶ʱ1
  82   1        TI = 1;        //    ģʽ0Уڷݵ8λʱӲԶTI1,жϣӦжϺTI
             -㣬ģʽֹͣλʼʱӲԶ1CPUжϣӦ㣬ģʽ0ͬλзʽ
  83   1      }
  84          
  85          void Uart2Init(void)    //9600bps  24MHZ
  86          {
  87   1        S2CON = 0x50;  //8λݣɱ䲨
  88   1        AUXR |= 0x04;  //  ʱ2ʼδFosc,1Tѡʱ1Ϊʷ
  89   1        T2L = 0x8F;   //趨ʱʼֵ
  90   1        T2H = 0xFD;   //趨ʱֵ
  91   1        AUXR |= 0x10;  //ʱ2
  92   1        IE |= ES2;     //ʹܴж
  93   1      }
  94          
  95          
  96          void PinInit()
  97          {
  98   1        //P0ΪOLEDĻĲнӿ
  99   1        P0 = 0x00;
 100   1        P0M0 = 0x00;
 101   1        P0M1 = 0x00;
 102   1        //ÿIOڶʹĴãP0ҪõP0MO,P0M1,P0еIOΪ׼˫ڣ20mA
             -
 103   1        //P10,P11 Ǵ2
 104   1        //P12,P13ΪʾD/C,RESţ(V1.0:P12=CS,P14=D/C)
 105   1        //P14,P15Ϊ IICţⲿ裬Ϊ©          
 106   1        //P16Ϊʹţߵƽʱ͹
 107   1        //P17Ϊʹţʱʹܳ磨V1.0 Ҫ֧֣
 108   1        //P13 = 1; //ʾRES    V1.0汾ΪD/C
 109   1        P13 = 1;    
 110   1        P16 = 1; 
 111   1        P1M0 = 0x30;  //00110000b
 112   1        P1M1 = 0xb0;  //10110000b
C51 COMPILER V9.52.0.0   SYS                                                               05/30/2021 20:33:33 PAGE 3   

 113   1        //P20ΪLEDţǿģʽV1.0 ΪP35
 114   1        //P21,P22Ϊⲿչţ 
 115   1        //P23ΪUP
 116   1        //P24,P25ΪI2Cţⲿ裬Ϊͨ˫
 117   1        //P26Ϊţǿģʽ
 118   1        //P27Ϊ,Ĭϸߵƽ
 119   1        P2 = 0xb9;  //10111001b
 120   1        P2M0 = 0x41;//01000001b
 121   1        P2M1 = 0x00;    
 122   1        //P37Ϊⲿж3Ĭϸߵƽ
 123   1        //P36Ϊⲿж2
 124   1        //P34ΪT0    Ϊ1
 125   1        //P33Ϊⲿж1         
 126   1        //P32Ϊⲿж0         Ϊ1
 127   1        //P30,P31Ϊ1
 128   1        P3 = 0x94;//1001 01       00b
 129   1        P3M0 = 0x00;
 130   1        P3M1 = 0x00;    
 131   1        //P44,P43ΪʾE/RD,R/W
 132   1        //P40Ϊ3.3Vʹ
 133   1        P4 = 0x19; //00011000b
 134   1        P4M0 = 0x00;
 135   1        P4M1 = 0x00;
 136   1        //P55ΪĬϸߵƽ   DOWN
 137   1        P5 = 0x20;    //0010 0000b
 138   1        P5M0 = 0x00;
 139   1        P5M1 = 0x00;
 140   1      }
 141          void EnableWatchDog(void)
 142          { 
 143   1        WDT_CONTR = 0x27;            //4.194sûιMCUԶλ
 144   1      }
 145          void FeedWatchDog(void)
 146          {
 147   1        WDT_CONTR |= 0x10;           //ιŹ
 148   1      }
 149          
 150          //void EEPROMWriteConfiguration(struct sys_config *config)
 151          //{
 152          //  unsigned char i= 0 ;
 153          //  unsigned int temp = 0;
 154          //  for(i; i < CONFIG_SIZE -2 ; i++)      //Խṹÿһֽ
 155          //    temp += ((unsigned char *)config)[i];
 156          //  config->check_sum = temp;
 157          //  EEPROM_SectorErase(EE_ADDRESS1);     //ͽڽṹһ
 158          //  EEPROM_write_n(EE_ADDRESS1,(unsigned char *)config,CONFIG_SIZE);
 159          //  
 160          //}
 161          
 162          
 163          
 164          void EEPROMWriteConfiguration(struct sys_config *config)
 165          {
 166   1        unsigned char i = 0;
 167   1        unsigned int temp = 0;
 168   1        for(i; i < CONFIG_SIZE - 2; i++)        //Խṹÿһֽ
 169   1          temp += ((unsigned char *)config)[i];
 170   1        config->check_sum = temp;
 171   1        EEPROM_SectorErase(EE_ADDRESS1);        //ͽڽṹһ
 172   1        EEPROM_write_n(EE_ADDRESS1, (unsigned char *)config, CONFIG_SIZE);
 173   1      }
 174            
C51 COMPILER V9.52.0.0   SYS                                                               05/30/2021 20:33:33 PAGE 4   

 175          unsigned char EEPROMReadConfiguration(struct sys_config *config)
 176          {
 177   1        unsigned char i = 0;
 178   1        unsigned int temp = 0;
 179   1        EEPROM_read_n(EE_ADDRESS1,(unsigned char *)config,CONFIG_SIZE);
 180   1        for(i; i < CONFIG_SIZE - 2; i++)    //Խṹÿһֽ
 181   1          temp += ((unsigned char *)config)[i];
 182   1        if(temp == config->check_sum)        //ǷȷṹֽΪֽ
 183   1            return 1;
 184   1        else
 185   1        {
 186   2          for(i = 0;i < CONFIG_SIZE; i++)
 187   2          ((unsigned char *)config)[i] = ((unsigned char *)(&default_config))[i];
 188   2          return 0;
 189   2        }
 190   1      }
 191          
 192          void LED(unsigned char k)
 193          {
 194   1        LED1 = k^0x01;     //ΪʲôҪ򣬶ȡ
 195   1      }
 196          
 197          void SysInit(void)
 198          {
 199   1        PinInit();   //ųʼ
 200   1        UartInit();   //1ʼ,ʹöʱ1
 201   1        Uart2Init();  //2ʼʹöʱ3
 202   1        Timer0Init();  //ʱ0ʼⲿģʽ
 203   1        Timer3Init();  //ʱ3ʼ1msж
 204   1        InitConfig(); //жϳʼ
 205   1        ADCInit();    //ADCʼ ɼԴѹ
 206   1        IIC_Init();   //ӲIICʼ
 207   1        EnableWatchDog();   //ʹܿŹ4sԶλ
 208   1        EEPROMReadConfiguration(&config);//籣
 209   1        BuzzerInit();  //ʼʹӲPWM7
 210   1        EnableBuzzer(config.key_sound);
 211   1        LED(OFF);
 212   1        BatteryChargeEnable(1);  //س
 213   1        Delay1ms(5);  
 214   1        Enable3V3Output(1);  //3.3V﮵
 215   1        EA = 1;         //ȫж
 216   1      }
 217          
 218          
 219          
 220          
 221          
 222          
 223          
 224          
 225          
 226          
 227          
 228          
 229          
 230          
 231          
 232          
 233          
 234          
 235          
 236          
C51 COMPILER V9.52.0.0   SYS                                                               05/30/2021 20:33:33 PAGE 5   

 237          
 238          
 239          
 240          
 241          
 242          
 243          
 244          
 245          
 246          
 247          
 248          
 249          
 250          
 251          
 252          
 253          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    514    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    117      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
