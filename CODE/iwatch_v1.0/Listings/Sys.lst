C51 COMPILER V9.52.0.0   SYS                                                               09/12/2021 19:38:16 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE SYS
OBJECT MODULE PLACED IN ..\Objects\Sys.obj
COMPILER INVOKED BY: E:\install_files\keil\C51\BIN\C51.EXE ..\User\System\Sys.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..
                    -\User\oled;..\User\rtc;..\User\System;..\User;..\User\bluetooth;..\User\radio;..\User\sensor) DEBUG OBJECTEXTEND PRINT(.
                    -.\Listings\Sys.lst) TABS(2) OBJECT(..\Objects\Sys.obj)

line level    source

   1          #include "sys.h"
   2          #include "IIC.h"
   3          #include "Delay.h"
   4          #include "PowerManage.h"
   5          #include "Buzzer.h"
   6          #include "EEPROM.h"
   7          
   8          
   9          
  10            
  11          //EEPROMûݻݲĬ
  12          const struct sys_config default_config = {
  13            //Ĭʾ
  14            10,           //ԶϢʱ
  15            5,            //Զʱ
  16            10,           //Ļȣ0~255
  17            NO_INVERSED,  //ĻǷɫ
  18            NORMAL,       //Ļʾ
  19            OFF,            //رհ
  20            //ĬӲ
  21            8,              //Сʱ
  22            30,             //
  23            1,              //1
  24            1,              //һ
  25            ALARM_DISABLE,  //ӹر
  26            //Ĭ
  27            1,      //
  28            97.1,   //Ƶ
  29            //ĬУ
  30            0,      //xƫ
  31            0,      //yƫ
  32            0,      //Уϵ
  33            0,      //Уϵ
  34            0,      //Уϵ
  35            1,      //Уϵ
  36            1,      //Уϵ
  37            {{0}, {0}, {0}, {0}, {0}, {0}, {0}},  //ƲʷݣŹȥĲ
  38            0       //Ҫ޸
  39          };
  40          
  41          extern struct sys_config config;  
  42          
  43          
  44          void PinInit()
  45          {
  46   1        //P0ΪOLEDĻĲнӿ  8080ʽжʹ(RE)дʹ(WE)6800ʹE,дѡW/R
  47   1        //ÿIOڶʹĴãP0ҪõP0MO,P0M1,P0еIOΪ׼˫ڣ20mA
             -
  48   1        P0 = 0x00;
  49   1        P0M0 = 0x00;
  50   1        P0M1 = 0x00;
  51   1        //P10,P11 Ǵ2
  52   1        //P12,P13ΪʾD/C,RSTţ(V1.0:P12=RST,P13=D/C)
C51 COMPILER V9.52.0.0   SYS                                                               09/12/2021 19:38:16 PAGE 2   

  53   1        //P14,P15Ϊ IICţⲿ裬Ϊ©          
  54   1        //P16Ϊʹţߵƽʱ͹
  55   1        //P17Ϊʹţʱʹܳ磨V1.0 :0R tie on GNDȥˣ
  56   1        P12 = 1; //ʾRST    
  57   1        P16 = 1;   
  58   1        P1M0 = 0x30;  //00110000b
  59   1        P1M1 = 0xb0;  //10110000b
  60   1        //P20ΪLEDţǿģʽV1.0ôãLED ΪP35
  61   1        //P21,P22Ϊⲿչţ 
  62   1        //P23ΪUP,Ĭϸߵƽ;
  63   1        //P24,P25ΪI2Cţⲿ裬Ϊͨ˫
  64   1        //P26Ϊţǿģʽ,Ĭϵ͵ƽ
  65   1        //P27Ϊ,Ĭϸߵƽ
  66   1        P2 = 0xb8;  //10111000b
  67   1        P2M0 = 0x40;//01000000b
  68   1        P2M1 = 0x00;//00000000b   
  69   1        //P37Ϊⲿж3Ĭϸߵƽ
  70   1        //P36Ϊⲿж2
  71   1        //P34ΪT0    Ϊ1ʣΪT_CLKOUT Ϊ©޷ߵƽ
  72   1        //P33Ϊⲿж1         
  73   1        //P32Ϊⲿж0         Ϊ1,1ΪT_INTǿ©͵ƽЧ
  74   1        //P30,P31Ϊ1
  75   1        P3 = 0x34;//0011 0100b
  76   1        P3M0 = 0x00;
  77   1        P3M1 = 0x00;    
  78   1        //P44,P43ΪʾE/RD,R/W
  79   1        //P40Ϊ3.3Vʹ(V1.0:ûʹ)
  80   1        P4 = 0x19; //00011000b
  81   1        P4M0 = 0x00;
  82   1        P4M1 = 0x00;
  83   1        //P55ΪĬϸߵƽ   DOWN
  84   1        P5 = 0x20;    //0010 0000b
  85   1        P5M0 = 0x00;
  86   1        P5M1 = 0x00;
  87   1      }
  88          
  89          void Timer0Init(void)
  90          {
  91   1        TMOD |= 0x04;   //ⲿģʽ
  92   1        TL0 = 0x00;
  93   1        TH0 = 0x00;
  94   1        TR0 = 0;       //رնʱ
  95   1        ET0 = 1;       //ʹܶʱж
  96   1      }
  97          void Timer3Init(void)    //ʱ1ms   24MHZ
  98          {
  99   1        T4T3M |= 0x02;     //T4R T4_C/T T4x12 T4CLKO ʱʱ1TģʽCPUʱӲƵfosc/1
 100   1        T3L = 0x40;        //öʱֵ
 101   1        T3H = 0xA2;        //öʱֵ
 102   1        T4T3M |= 0x08;     //ʱ3ʼʱ
 103   1        IE2 |= ET3;        //ʱ3ж
 104   1      }
 105          
 106          #ifdef badapple
              extern unsigned char xdata sub_cache2[];
              unsigned int rx_buf_num = 0;
              bit frame_received_flag = 0;
              bit serial_busy = 0;
              void UartInit(void)     //576000bps  24MHz
              {
                SCON = 0x50;   //   SM0 SM1 SM2 REN TB RB8 TI RI 8λݣɱ䲨
                AUXR |= 0x40;  //   AUXRĴT1x12Ϊ1CPUʱӲƵΪ0Ϊ12Ƶ
C51 COMPILER V9.52.0.0   SYS                                                               09/12/2021 19:38:16 PAGE 3   

                AUXR &= 0xFE;  //   bit0⣬λԭò
                TMOD &= 0x0F;  //   4λ GATE C/T M1 M0    λ㣬λֲ(T1-gate,T1Ϊʱ
             -ϵͳڲʱӽмΪ16λԶװģʽT0ֲ)
                TL1 = 0xF6;    //   0xcc  246
                TH1 = 0xFF;    //   0xff  255    ÿװǶ
                ET1 = 0;       //   ʱ/T1жλֹT1ж
                TR1 = 1;       //   򿪶ʱ1
                ES = 1;        //   ж
                TI = 1;        //   ģʽ0Уڷݵ8λʱӲԶTI1,жϣӦжϺTI
             -㣬ģʽֹͣλʼʱӲԶ1CPUжϣӦ㣬ģʽ0ͬλзʽ
              }      
              void UART1_Isr()  interrupt 4  using 1
              {
                if(RI)
                {
                  RI = 0;      //жϱ־λ
                  if(SBUF == MCU_RESET_CMD)
                    MCUSoftReset();  //λMCU
                }
                if(RI)
                {
                  RI = 0;
                  sub_cache[rx_buf_num++] = SBUF;
                  if(rx_buf_num == 1024)
                  {
                    rx_buf_num = 0;
                    frame_received_flag =1;
                  }
                }
                if(TI)
                {
                  TI = 0;
                  serial_busy = 0;
                }
              }
              void UART1SendString(char *str)
              {
                while(*str)
                {
                  while(serial_busy);
                  serial_busy = 1;
                  SBUF = *str++;
                }
              }
              void StartFrameReceive()
              {
                UART1SendString("ok");
                frame_received_flag = 0;
                rx_buf_num = 0;
              }
              unsigned char CheckFrameRecevied()
              {
                if(frame_received_flag)
                {
                  frame_received_flag = 0;
                  return 1;
                }
                else 
                  return 0;
              }
              #else
 174          
C51 COMPILER V9.52.0.0   SYS                                                               09/12/2021 19:38:16 PAGE 4   

 175          void UartInit(void)       //115200bps@24.000MHz      1öʱ1
 176          {
 177   1        SCON = 0x50;  // SM0 SM1 SM2 REN TB RB8 TI RI 8λݣɱ䲨
 178   1        AUXR |= 0x40;  //   AUXRĴT1x12Ϊ1CPUʱӲƵΪ0Ϊ12Ƶ
 179   1        AUXR &= 0xFE;  //  bit0⣬λԭò
 180   1        TMOD &= 0x0F;  //   4λ GATE C/T M1 M0    λ㣬λֲ(T1-gate,T1Ϊʱ
             -ϵͳڲʱӽмΪ16λԶװģʽT0ֲ)
 181   1        TL1 = 0xCC;    //   0xcc  204
 182   1        TH1 = 0xFF;    //   0xff  255    ÿװǶ
 183   1        ET1 = 0;       //   ʱ/T1жλֹT1ж
 184   1        TR1 = 1;       //   򿪶ʱ1
 185   1        TI = 1;        //    ģʽ0Уڷݵ8λʱӲԶTI1,жϣӦжϺTI
             -㣬ģʽֹͣλʼʱӲԶ1CPUжϣӦ㣬ģʽ0ͬλзʽ
 186   1      }
 187          
 188          #endif
 189          
 190          void Uart2Init(void)    //9600bps  24MHZ        2öʱ    
 191          {
 192   1        S2CON = 0x50;  //8λݣɱ䲨
 193   1        AUXR |= 0x04;  //  ʱ2ʼδFosc,1Tѡʱ1Ϊʷ
 194   1        T2L = 0x8F;   //趨ʱʼֵ
 195   1        T2H = 0xFD;   //趨ʱֵ
 196   1        AUXR |= 0x10;  //ʱ2
 197   1        IE |= ES2;     //ʹܴж
 198   1      }
 199          
 200          void InitConfig(void)    //жϳʼ
 201          {
 202   1        IT0 = 1;    //ʹINT0½жϣӦPCF8653ж
 203   1        EX0 = 1;    //ʹINT0ж
 204   1        IT1 = 1;    //ʹINT1½жϣӦLSM6DSMжINT1
 205   1        EX1 = 1;    //ʹINT1ж
 206   1        INTCLKO |= EX2; //ʹINT2ж    ӦLSM6DDSMж2
 207   1        //INTCLKO |= EX3;  //ʹINT3ж    Ӧ2жϣ  ˴V1.2ͬ
 208   1        //INTCLKO |= EX4;  //ʹINT4ж 
 209   1      }
 210          void MCUSoftReset(void)   //Ƭλ
 211          {
 212   1        IAP_CONTR = 0x60;       //Ƭλָ
 213   1      }
 214          
 215          void EnableWatchDog(void)
 216          { 
 217   1        WDT_CONTR = 0x27;            //4.194sûιMCUԶλ
 218   1      }
 219          void FeedWatchDog(void)
 220          {
 221   1        WDT_CONTR |= 0x10;           //ιŹ
 222   1      }
 223          void EEPROMWriteConfiguration(struct sys_config *config)
 224          {
 225   1        unsigned char i = 0;
 226   1        unsigned int temp = 0;
 227   1        for(i; i < CONFIG_SIZE - 2; i++)        //Խṹÿһֽ
 228   1          temp += ((unsigned char *)config)[i];
 229   1        config->check_sum = temp;
 230   1        EEPROM_SectorErase(EE_ADDRESS1);        //ͽڽṹһ
 231   1        EEPROM_write_n(EE_ADDRESS1, (unsigned char *)config, CONFIG_SIZE);
 232   1      }
 233            
 234          unsigned char EEPROMReadConfiguration(struct sys_config *config)
C51 COMPILER V9.52.0.0   SYS                                                               09/12/2021 19:38:16 PAGE 5   

 235          {
 236   1        unsigned char i = 0;
 237   1        unsigned int temp = 0;
 238   1        EEPROM_read_n(EE_ADDRESS1,(unsigned char *)config,CONFIG_SIZE);
 239   1        for(i; i < CONFIG_SIZE - 2; i++)    //Խṹÿһֽ
 240   1          temp += ((unsigned char *)config)[i];
 241   1        if(temp == config->check_sum)        //ǷȷṹֽΪֽ
 242   1            return 1;
 243   1        else
 244   1        {
 245   2          for(i = 0;i < CONFIG_SIZE; i++)
 246   2          ((unsigned char *)config)[i] = ((unsigned char *)(&default_config))[i];
 247   2          return 0;
 248   2        }
 249   1      }
 250          
 251          void LED(unsigned char k)
 252          {
 253   1        LED1 = k^0x01;     //Ŀԭ״̬෴
 254   1      }
 255             
 256          void SysInit(void)            
 257          {      
 258   1        PinInit();   //ųʼ
 259   1        UartInit();   //1ʼ,ʹöʱ1
 260   1        Uart2Init();  //2ʼʹöʱ3
 261   1        Timer0Init();  //ʱ0ʼⲿģʽ
 262   1        Timer3Init();  //ʱ3ʼ1msж
 263   1        InitConfig(); //жϳʼ
 264   1        ADCInit();    //ADCʼ ɼԴѹ
 265   1        IIC_Init();   //ӲIICʼ
 266   1        EnableWatchDog();   //ʹܿŹ4sԶλ
 267   1        EEPROMReadConfiguration(&config);//籣
 268   1        BuzzerInit();  //ʼʹӲPWM7
 269   1        EnableBuzzer(config.key_sound);
 270   1        LED(OFF);
 271   1        BatteryChargeEnable(1);  //س
 272   1        Delay1ms(5);  
 273   1        Enable3V3Output(1);  //3.3V﮵
 274   1        EA = 1;         //ȫж
 275   1      }
 276          
 277          
 278          
 279          
 280          
 281          
 282          
 283          
 284          
 285          
 286             
 287          
 288          
 289          
 290          
 291          
 292          
 293          
 294          
 295          
 296          
C51 COMPILER V9.52.0.0   SYS                                                               09/12/2021 19:38:16 PAGE 6   

 297          
 298          
 299          
 300          
 301          
 302          
 303          
 304          
 305          
 306          
 307          
 308          
 309          
 310          
 311          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    515    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    117      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
