C51 COMPILER V9.52.0.0   SYS                                                               06/15/2021 23:47:20 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE SYS
OBJECT MODULE PLACED IN ..\Objects\Sys.obj
COMPILER INVOKED BY: E:\install_files\keil\C51\BIN\C51.EXE ..\User\System\Sys.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..
                    -\User\System;..\User\Sensor;..\User\Rtc;..\User\Radio;..\User\Oled;..\User\Bluetooth;..\User) DEBUG OBJECTEXTEND PRINT(.
                    -.\Listings\Sys.lst) TABS(2) OBJECT(..\Objects\Sys.obj)

line level    source

   1          #include "sys.h"
   2          #include "IIC.h"
   3          #include "Delay.h"
   4          #include "PowerManage.h"
   5          #include "Buzzer.h"
   6          #include "EEPROM.h"
   7          
   8          
   9          
  10            
  11          //EEPROMûݻݲĬ
  12          const struct sys_config default_config = {
  13            //Ĭʾ
  14            10,           //ԶϢʱ
  15            5,            //Զʱ
  16            50,           //Ļȣ0~255
  17            NO_INVERSED,  //ĻǷɫ
  18            NORMAL,       //Ļʾ
  19            OFF,          //رհ
  20            //ĬӲ
  21            8,              //Сʱ
  22            30,             //
  23            1,              //1
  24            1,              //һ
  25            ALARM_DISABLE,  //ӹر
  26            //Ĭ
  27            1,      //
  28            97.1,   //Ƶ
  29            //ĬУ
  30            0,      //xƫ
  31            0,      //yƫ
  32            0,      //Уϵ
  33            0,      //Уϵ
  34            0,      //Уϵ
  35            1,      //Уϵ
  36            1,      //Уϵ
  37            {{0}, {0}, {0}, {0}, {0}, {0}, {0}},  //ƲʷݣŹȥĲ
  38            0       //Ҫ޸
  39          };
  40          
  41          extern struct sys_config config;  
  42          
  43          
  44          void PinInit()
  45          {
  46   1        //P0ΪOLEDĻĲнӿ  8080ʽжʹ(RE)дʹ(WE)6800ʹE,дѡW/R
  47   1        //ÿIOڶʹĴãP0ҪõP0MO,P0M1,P0еIOΪ׼˫ڣ20mA
             -
  48   1        P0 = 0x00;
  49   1        P0M0 = 0x00;
  50   1        P0M1 = 0x00;
  51   1        //P10,P11 Ǵ2
  52   1        //P12,P13ΪʾD/C,RESţ(V1.0:P12=CS,P14=D/C)
C51 COMPILER V9.52.0.0   SYS                                                               06/15/2021 23:47:20 PAGE 2   

  53   1        //P14,P15Ϊ IICţⲿ裬Ϊ©          
  54   1        //P16Ϊʹţߵƽʱ͹
  55   1        //P17Ϊʹţʱʹܳ磨V1.0 Ҫ֧.֧֣
  56   1        //P13 = 1; //ʾRES    V1.0汾ΪD/CӲRSTֱ3.3V)
  57   1           
  58   1        P16 = 1; 
  59   1        P1M0 = 0x00;  //00000000b
  60   1        P1M1 = 0x30;  //00110000b
  61   1        //P20ΪLEDţǿģʽV1.0ôãLED ΪP35
  62   1        //P21,P22Ϊⲿչţ 
  63   1        //P23ΪUP,Ĭϸߵƽ;
  64   1        //P24,P25ΪI2Cţⲿ裬Ϊͨ˫
  65   1        //P26Ϊţǿģʽ
  66   1        //P27Ϊ,Ĭϸߵƽ
  67   1        P2 = 0xb8;  //10111000b
  68   1        P2M0 = 0x40;//01000000b
  69   1        P2M1 = 0x00;//00000000b   
  70   1        //P37Ϊⲿж3Ĭϸߵƽ
  71   1        //P36Ϊⲿж2
  72   1        //P34ΪT0    Ϊ1ʣΪT_CLKOUT Ϊ©޷ߵƽ
  73   1        //P33Ϊⲿж1         
  74   1        //P32Ϊⲿж0         Ϊ1,1ΪT_INTǿ©͵ƽЧ
  75   1        //P30,P31Ϊ1
  76   1        P3 = 0x34;//0011 0100b
  77   1        P3M0 = 0x00;
  78   1        P3M1 = 0x00;    
  79   1        //P44,P43ΪʾE/RD,R/W
  80   1        //P40Ϊ3.3Vʹ
  81   1        P4 = 0x18; //00011000b
  82   1        P4M0 = 0x00;
  83   1        P4M1 = 0x00;
  84   1        //P55ΪĬϸߵƽ   DOWN
  85   1        P5 = 0x30;    //0011 0000b
  86   1        P5M0 = 0x00;
  87   1        P5M1 = 0x00;
  88   1      }
  89          
  90          void Timer0Init(void)
  91          {
  92   1        TMOD |= 0x04;   //ⲿģʽ
  93   1        TL0 = 0x00;
  94   1        TH0 = 0x00;
  95   1        TR0 = 0;       //رնʱ
  96   1        ET0 = 1;       //ʹܶʱж
  97   1      }
  98          void Timer3Init(void)    //ʱ1ms   24MHZ
  99          {
 100   1        T4T3M |= 0x02;     //T4R T4_C/T T4x12 T4CLKO ʱʱ1TģʽCPUʱӲƵfosc/1
 101   1        T3L = 0x40;        //öʱֵ
 102   1        T3H = 0xA2;        //öʱֵ
 103   1        T4T3M |= 0x08;     //ʱ3ʼʱ
 104   1        IE2 |= ET3;        //ʱ3ж
 105   1      }
 106          
 107          #ifdef badapple
              extern unsigned char xdata sub_cache2[];
              unsigned int rx_buf_num = 0;
              bit frame_received_flag = 0;
              bit serial_busy = 0;
              void UartInit(void)     //576000bps  24MHz
              {
                SCON = 0x50;   //   SM0 SM1 SM2 REN TB RB8 TI RI 8λݣɱ䲨
C51 COMPILER V9.52.0.0   SYS                                                               06/15/2021 23:47:20 PAGE 3   

                AUXR |= 0x40;  //   AUXRĴT1x12Ϊ1CPUʱӲƵΪ0Ϊ12Ƶ
                AUXR &= 0xFE;  //   bit0⣬λԭò
                TMOD &= 0x0F;  //   4λ GATE C/T M1 M0    λ㣬λֲ(T1-gate,T1Ϊʱ
             -ϵͳڲʱӽмΪ16λԶװģʽT0ֲ)
                TL1 = 0xF6;    //   0xcc  246
                TH1 = 0xFF;    //   0xff  255    ÿװǶ
                ET1 = 0;       //   ʱ/T1жλֹT1ж
                TR1 = 1;       //   򿪶ʱ1
                ES = 1;        //   ж
                TI = 1;        //   ģʽ0Уڷݵ8λʱӲԶTI1,жϣӦжϺTI
             -㣬ģʽֹͣλʼʱӲԶ1CPUжϣӦ㣬ģʽ0ͬλзʽ
              }      
              void UART1_Isr()  interrupt 4  using 1
              {
                if(RI)
                {
                  RI = 0;      //жϱ־λ
                  if(SBUF == MCU_RESET_CMD)
                    MCUSoftReset();  //λMCU
                }
                if(RI)
                {
                  RI = 0;
                  sub_cache[rx_buf_num++] = SBUF;
                  if(rx_buf_num == 1024)
                  {
                    rx_buf_num = 0;
                    frame_received_flag =1;
                  }
                }
                if(TI)
                {
                  TI = 0;
                  serial_busy = 0;
                }
              }
              void UART1SendString(char *str)
              {
                while(*str)
                {
                  while(serial_busy);
                  serial_busy = 1;
                  SBUF = *str++;
                }
              }
              void StartFrameReceive()
              {
                UART1SendString("ok");
                frame_received_flag = 0;
                rx_buf_num = 0;
              }
              unsigned char CheckFrameRecevied()
              {
                if(frame_received_flag)
                {
                  frame_received_flag = 0;
                  return 1;
                }
                else 
                  return 0;
              }
              #else
C51 COMPILER V9.52.0.0   SYS                                                               06/15/2021 23:47:20 PAGE 4   

 175          
 176          void UartInit(void)       //115200bps@24.000MHz      1öʱ1
 177          {
 178   1        SCON = 0x50;  // SM0 SM1 SM2 REN TB RB8 TI RI 8λݣɱ䲨
 179   1        AUXR |= 0x40;  //   AUXRĴT1x12Ϊ1CPUʱӲƵΪ0Ϊ12Ƶ
 180   1        AUXR &= 0xFE;  //  bit0⣬λԭò
 181   1        TMOD &= 0x0F;  //   4λ GATE C/T M1 M0    λ㣬λֲ(T1-gate,T1Ϊʱ
             -ϵͳڲʱӽмΪ16λԶװģʽT0ֲ)
 182   1        TL1 = 0xCC;    //   0xcc  204
 183   1        TH1 = 0xFF;    //   0xff  255    ÿװǶ
 184   1        ET1 = 0;       //   ʱ/T1жλֹT1ж
 185   1        TR1 = 1;       //   򿪶ʱ1
 186   1        TI = 1;        //    ģʽ0Уڷݵ8λʱӲԶTI1,жϣӦжϺTI
             -㣬ģʽֹͣλʼʱӲԶ1CPUжϣӦ㣬ģʽ0ͬλзʽ
 187   1      }
 188          
 189          #endif
 190          
 191          void Uart2Init(void)    //9600bps  24MHZ        2öʱ    
 192          {
 193   1        S2CON = 0x50;  //8λݣɱ䲨
 194   1        AUXR |= 0x04;  //  ʱ2ʼδFosc,1Tѡʱ1Ϊʷ
 195   1        T2L = 0x8F;   //趨ʱʼֵ
 196   1        T2H = 0xFD;   //趨ʱֵ
 197   1        AUXR |= 0x10;  //ʱ2
 198   1        IE |= ES2;     //ʹܴж
 199   1      }
 200          
 201          void InitConfig(void)    //жϳʼ
 202          {
 203   1        IT0 = 1;    //ʹINT0½жϣӦPCF8653ж
 204   1        EX0 = 1;    //ʹINT0ж
 205   1        IT1 = 1;    //ʹINT1½жϣӦLSM6DSMжINT1
 206   1        EX1 = 1;    //ʹINT1ж
 207   1        INTCLKO |= EX2; //ʹINT2ж    ӦLSM6DDSMж2
 208   1        //INTCLKO |= EX3;  //ʹINT3ж    Ӧ2жϣ  ˴V1.2ͬ
 209   1        //INTCLKO |= EX4;  //ʹINT4ж 
 210   1      }
 211          void MCUSoftReset(void)   //Ƭλ
 212          {
 213   1        IAP_CONTR = 0x60;       //Ƭλָ
 214   1      }
 215          
 216          void EnableWatchDog(void)
 217          { 
 218   1        WDT_CONTR = 0x27;            //4.194sûιMCUԶλ
 219   1      }
 220          void FeedWatchDog(void)
 221          {
 222   1        WDT_CONTR |= 0x10;           //ιŹ
 223   1      }
 224          
 225          //void EEPROMWriteConfiguration(struct sys_config *config)
 226          //{
 227          //  unsigned char i= 0 ;
 228          //  unsigned int temp = 0;
 229          //  for(i; i < CONFIG_SIZE -2 ; i++)      //Խṹÿһֽ
 230          //    temp += ((unsigned char *)config)[i];
 231          //  config->check_sum = temp;
 232          //  EEPROM_SectorErase(EE_ADDRESS1);     //ͽڽṹһ
 233          //  EEPROM_write_n(EE_ADDRESS1,(unsigned char *)config,CONFIG_SIZE);
 234          //  
C51 COMPILER V9.52.0.0   SYS                                                               06/15/2021 23:47:20 PAGE 5   

 235          //}
 236          
 237          
 238          
 239          void EEPROMWriteConfiguration(struct sys_config *config)
 240          {
 241   1        unsigned char i = 0;
 242   1        unsigned int temp = 0;
 243   1        for(i; i < CONFIG_SIZE - 2; i++)        //Խṹÿһֽ
 244   1          temp += ((unsigned char *)config)[i];
 245   1        config->check_sum = temp;
 246   1        EEPROM_SectorErase(EE_ADDRESS1);        //ͽڽṹһ
 247   1        EEPROM_write_n(EE_ADDRESS1, (unsigned char *)config, CONFIG_SIZE);
 248   1      }
 249            
 250          unsigned char EEPROMReadConfiguration(struct sys_config *config)
 251          {
 252   1        unsigned char i = 0;
 253   1        unsigned int temp = 0;
 254   1        EEPROM_read_n(EE_ADDRESS1,(unsigned char *)config,CONFIG_SIZE);
 255   1        for(i; i < CONFIG_SIZE - 2; i++)    //Խṹÿһֽ
 256   1          temp += ((unsigned char *)config)[i];
 257   1        if(temp == config->check_sum)        //ǷȷṹֽΪֽ
 258   1            return 1;
 259   1        else
 260   1        {
 261   2          for(i = 0;i < CONFIG_SIZE; i++)
 262   2          ((unsigned char *)config)[i] = ((unsigned char *)(&default_config))[i];
 263   2          return 0;
 264   2        }
 265   1      }
 266          
 267          void LED(unsigned char k)
 268          {
 269   1        LED1 = k^0x01;     //ΪʲôҪ򣬶ȡ
 270   1      }
 271             
 272          void SysInit(void)            
 273          {
 274   1        PinInit();   //ųʼ
 275   1        UartInit();   //1ʼ,ʹöʱ1
 276   1        Uart2Init();  //2ʼʹöʱ3
 277   1        Timer0Init();  //ʱ0ʼⲿģʽ
 278   1        Timer3Init();  //ʱ3ʼ1msж
 279   1        InitConfig(); //жϳʼ
 280   1        ADCInit();    //ADCʼ ɼԴѹ
 281   1        IIC_Init();   //ӲIICʼ
 282   1        EnableWatchDog();   //ʹܿŹ4sԶλ
 283   1        EEPROMReadConfiguration(&config);//籣
 284   1        BuzzerInit();  //ʼʹӲPWM7
 285   1        EnableBuzzer(config.key_sound);
 286   1        LED(ON);
 287   1        //BatteryChargeEnable(1);  //س
 288   1        Delay1ms(5);  
 289   1        //Enable3V3Output(1);  //3.3V﮵
 290   1        EA = 1;         //ȫж
 291   1      }
 292          
 293          
 294          
 295          
 296          
C51 COMPILER V9.52.0.0   SYS                                                               06/15/2021 23:47:20 PAGE 6   

 297          
 298          
 299          
 300          
 301          
 302          
 303          
 304          
 305          
 306          
 307          
 308          
 309          
 310          
 311          
 312          
 313          
 314          
 315          
 316          
 317          
 318          
 319          
 320          
 321          
 322          
 323          
 324          
 325          
 326          
 327          
 328          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    503    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    117      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
